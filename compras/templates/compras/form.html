{% extends "base.html" %}
{% block title %}{% if compra %}Editar Compra #{{ compra.id }}{% else %}Nueva Compra{% endif %}{% endblock %}

{% block content %}
<h1>{% if compra %}Editar Compra #{{ compra.id }}{% else %}Nueva Compra{% endif %}</h1>

<form method="post" id="form-compra">
    {% csrf_token %}
    {{ formulario_compra.non_field_errors }}

    <div class="card">
    <div>
        {{ formulario_compra.proveedor.label_tag }} {{ formulario_compra.proveedor }}
    </div>
    <div>
        {{ formulario_compra.fecha.label_tag }} {{ formulario_compra.fecha }}
    </div>
    <div>
        {{ formulario_compra.descuento_porcentaje.label_tag }} {{ formulario_compra.descuento_porcentaje }}
        <small>(%)</small>
    </div>
    <div>
        {{ formulario_compra.descuento_total.label_tag }} {{ formulario_compra.descuento_total }}
        <small>(monto)</small>
    </div>
    <div>
        {{ formulario_compra.impuesto_total.label_tag }} {{ formulario_compra.impuesto_total }}
    </div>
</div>

<h3>Líneas</h3>
    {{ formulario_detalle_compra.management_form }}
    <table id="tabla-lineas" class="table">
    <thead>
    <tr>
        <th>Producto</th><th>Cantidad</th><th>Precio unitario</th><th>Total línea</th><th>Eliminar</th>
    </tr>
    </thead>
    <tbody>
        {% for f in formulario_detalle_compra %}
        {% include "compras/_partials/_form_linea.html" with f=f %}
        {% endfor %}
    </tbody>
</table>

{% include "compras/_partials/_totales_box.html" %}

<button type="submit" class="btn-main">Guardar</button>
</form>
{% endblock %}

{% block scripts %}
<script>
function toNumber(value){ const n = parseFloat(value); return isNaN(n) ? 0 : n; }

function recalcularTotales(){
    let subtotal = 0;
    document.querySelectorAll('#tabla-lineas tbody tr').forEach(function(fila){
    const cantidadInput = fila.querySelector('[name$="-cantidad"]');
    const precioInput   = fila.querySelector('[name$="-precio_unitario"]');
    const eliminarChk   = fila.querySelector('[name$="-DELETE"]');

    const cantidad = toNumber(cantidadInput ? cantidadInput.value : 0);
    const precio   = toNumber(precioInput ? precioInput.value : 0);
    const totalLinea = cantidad * precio;

    const celdaTotal = fila.querySelector('.cell-total-linea');
    if (celdaTotal) celdaTotal.textContent = totalLinea.toFixed(2);

    if (!eliminarChk || !eliminarChk.checked) subtotal += totalLinea;
});

    const descuentoMonto = toNumber(document.getElementById('id_descuento_total')?.value);
    const impuestoMonto  = toNumber(document.getElementById('id_impuesto_total')?.value);

    const total = subtotal - descuentoMonto + impuestoMonto;

    const viewSubtotal = document.getElementById('subtotal_view');
    const viewTotal    = document.getElementById('total_view');
    if (viewSubtotal) viewSubtotal.textContent = subtotal.toFixed(2);
    if (viewTotal)    viewTotal.textContent    = total.toFixed(2);
}

document.addEventListener('input', function(e){
    const esLinea = e.target.closest('#tabla-lineas') !== null;
    const idsAfectanTotales = ['id_descuento_total','id_impuesto_total'];
    if (esLinea || idsAfectanTotales.includes(e.target.id)) {
        recalcularTotales();
}
});

document.addEventListener('DOMContentLoaded', recalcularTotales);
</script>
{% endblock %}