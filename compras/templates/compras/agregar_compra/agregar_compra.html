{% extends "base.html" %}
{% load static %}
{% block flash_messages %}{% endblock %}
{% block title %}Compras · Agregar{% endblock %}

{% block extra_head %}

<!--<link rel="stylesheet" href="{% static 'css/global.css' %}">-->
<!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->

<style>
.container { max-width: 1200px; }
.page-header { margin: 24px 0 12px; }
.page-title { margin: 0; color: #094067; font-weight: 700; }
.page-subtitle { margin: 6px 0 0; color: #6c757d; }
.card { border-radius: 10px; box-shadow: 0 2px 18px rgba(44,62,80,0.08); border: 1px solid #dfe6e9; }
.card-header { background: #3a5068; color: #fff; border-bottom: 1px solid #dfe6e9; }
.card-title { margin: 0; font-size: 1.12rem; font-weight: 700; }
.btn-main { background: #3da9fc; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 700; box-shadow: 0 2px 8px #09406720; transition: background .18s, box-shadow .18s; text-decoration: none; }
.btn-main:hover { background: #094067; color: #fff; box-shadow: 0 4px 16px #3da9fc2a; }
.btn-outline { background: #fff; color: #094067; border: 1px solid #dfe6e9; border-radius: 8px; padding: 10px 18px; font-weight: 600; text-decoration: none; }
.table-responsive { overflow-x: auto; }
.table th, .table td { vertical-align: middle; white-space: nowrap; }
.form-rows-2col { display: grid; grid-template-columns: 240px 1fr; column-gap: 16px; row-gap: 12px; align-items: center; }
.form-label-left { font-weight: 600; text-align: left; color: #094067; }
.form-label-left .req { color: #ef4565; }
.form-field { display: flex; align-items: center; gap: 8px; }
.form-field input, .form-field select, .form-field textarea { width: 100%; max-width: 420px; text-align: left; }
.invalid-feedback { margin-top: 4px; }
.totals-card { max-width: 420px; margin-left: auto; }
.totals-grid { display: grid; gap: 8px; }
.totals-row { display:flex; justify-content: space-between; }
.totals-row--strong { font-weight: 700; font-size: 1.05rem; }
.card-header--flex { display:flex; justify-content: space-between; align-items:center; }
@media (max-width: 700px) {
    .form-rows-2col { grid-template-columns: 1fr; }
    .form-field input, .form-field select, .form-field textarea { max-width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
<div class="page-header">
    <h1 class="page-title">NUEVA COMPRA</h1>
    <p class="page-subtitle">Ingrese los datos de la compra</p>
</div>

{# Mensajes flash #}
{% if messages %}
    <div class="mb-3">
    {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
        {{ message }}
        </div>
    {% endfor %}
    </div>
{% endif %}

<form method="post" novalidate>
    {% csrf_token %}

    {# ======= DATOS DE LA COMPRA ======= #}
    {% include "compras/agregar_compra/partials/_agregar_compra_cabecera.html" with form=form %}

    {# ======= PRODUCTOS + TOTALES (dentro de la misma card como en tu versión) ======= #}
    <div class="card mb-3">
    <div class="card-header card-header--flex">
        <h2 class="card-title">Productos de la compra</h2>
        <button type="button" class="btn btn-outline" id="btn-add-row">+ Agregar línea</button>
    </div>
    <div class="card-body">
        {% include "compras/agregar_compra/partials/_agregar_compra_lineas.html" with formset=formset %}
        {% include "compras/agregar_compra/partials/_agregar_compra_totales.html" %}
    </div>
    </div>

    {# ======= ACCIONES ======= #}
    {% include "compras/agregar_compra/partials/_agregar_compra_acciones.html" %}
</form>
</div>
{% endblock %}


<!--
{% block extra_js %}
{% include "compras/agregar_compra/partials/_agregar_compra_scripts.html" %}
{% endblock %}
-->


<!--
Ese console.log echa humo si el bloque scripts de la página se está renderizando.
La variable window.__compras_scripts_block nos permite verificar desde consola.
-->
{# SOLO UN BLOQUE SCRIPTS #}
{% block scripts %}
    {% include "compras/agregar_compra/partials/_agregar_compra_scripts.html" %}
    <script>
    console.log('[compras] bloque scripts de agregar_compra.html cargado');
    </script>
{% endblock %}