<script>
/**
 * IIFE (Immediately Invoked Function Expression)
 * Encapsula todo el código para no contaminar el scope global
 * y ejecuta la inicialización apenas carga la página.
 */
(function() {
/**-----------------------------------------------------------------------------------------------------------------------
   * Convierte cadenas numéricas con formato latino a número JS.
   * - Soporta miles con punto y decimales con coma: "1.234,56" -> 1234.56
   * - Si la conversión falla, retorna 0 para robustez.
   * @function toNumber
   * @param {string|number|null|undefined} val - Valor a convertir.
   * @returns {number} Número convertido o 0 si no es válido.
  Con coma: tratamos . como miles y , como decimales → “1.234,56” = 1234.56.
  Sin coma: respetamos el punto decimal tal cual (no lo borramos) → “12.90” = 12.9.
    ----------------------------------------------------------------------------------------------------------------------*/

  


    function toNumber(val) {
  if (val == null) return 0;
  if (typeof val === 'number') return val || 0;
  const s = String(val).trim();
  if (!s) return 0;

  // Si hay coma, interpretamos formato latino: 1.234,56 -> 1234.56
  if (s.includes(',')) {
    return Number(s.replace(/\./g, '').replace(',', '.')) || 0;
  }
  // Si NO hay coma, interpretamos punto como decimal estándar: 12.90 -> 12.90
  return Number(s) || 0;
}
/**---------------------------------------------------------------------------------------------------------------------
   * Recorre todas las filas del formset de líneas de compra y:
   * 1) Obtiene cantidad, precio y descuento por fila.
   * 2) Calcula el subtotal de cada fila (considerando % descuento).
   * 3) Actualiza los campos/elementos de subtotal visibles por fila.
   * 4) Aplica un descuento global si existe y actualiza los totales finales.
   * 5) Renderiza ui-subtotal, ui-descuento y ui-total (si existen).
   * @function updateTotals
   * @returns {void}
    ---------------------------------------------------------------------------------------------------------------------*/
function updateTotals() {
    const rows = document.querySelectorAll('#line-items-table tbody tr.line-row');
    let subtotal = 0;

    rows.forEach(tr => {
    // Selectores tolerantes a distintos nombres en el formset (ES/EN)
    const qty   = tr.querySelector('input[name*="-cantidad"], input[name*="-qty"], input[name*="-quantity"]');
    const price = tr.querySelector('input[name*="-precio"], input[name*="-price"], input[name*="-unit"]');
    const disc  = tr.querySelector('input[name*="-descuento"], input[name*="-discount"]');

    const q = qty ? toNumber(qty.value)   : 0;
    const p = price ? toNumber(price.value) : 0;
    const d = disc ? toNumber(disc.value)  : 0;
        // Subtotal línea = cantidad * precio; aplica % descuento si existe
      let line = q * p;
      if (d) line = line * (1 - d / 100);
    subtotal += line;
        // Escribe el subtotal por línea en input/readonly o en un <span data-subtotal>
    const subCell = tr.querySelector('input[name*="-subtotal"], input[readonly][name*="sub"]');
    if (subCell) subCell.value = line.toFixed(2).replace('.', ',');
    const span = tr.querySelector('[data-subtotal]');
    if (span) span.textContent = line.toFixed(2).replace('.', ',');
    });
     // Descuento global (%)
    const descGlobalInput = document.querySelector('input[name*="descuento_porcentaje"], input[name*="descuento"]');
    const descPct = descGlobalInput ? toNumber(descGlobalInput.value) : 0;
    const descuento = descPct > 0 ? subtotal * (descPct / 100) : 0;

    // Base imponible = subtotal - descuento (no negativa)
    const baseImponible = Math.max(subtotal - descuento, 0);

  // IVA como porcentaje (ej. 23 => 23%)
    const ivaInput = document.querySelector('input[name*="impuesto_total"]');
    const ivaPct = ivaInput ? toNumber(ivaInput.value) : 0;
    const impuestos = ivaPct > 0 ? baseImponible * (ivaPct / 100) : 0;

    const total = baseImponible + impuestos;

    // Helper por id
    const $ = (id) => document.getElementById(id);

    // Escribe en TUS IDs reales del HTML
    if ($('subtotal-general'))  $('subtotal-general').textContent  = subtotal.toFixed(2).replace('.', ',');
    if ($('descuento-general')) $('descuento-general').textContent = descuento.toFixed(2).replace('.', ',');
    if ($('impuestos-general')) $('impuestos-general').textContent = impuestos.toFixed(2).replace('.', ',');
    if ($('total-general'))     $('total-general').textContent     = total.toFixed(2).replace('.', ',');
}

/**------------------------------------------------------------------------------------------------------------------------
   * Reindexa los nombres/ids/for de todos los campos del formset
   * para que coincidan con el índice visual de cada fila.
   * También actualiza el hidden TOTAL_FORMS con el número de filas.
   * Esto es imprescindible para que Django procese bien el formset.
   * @function reindexFormset
   * @returns {void}
    ------------------------------------------------------------------------------------------------------------------------*/
function reindexFormset() {
  const tbody = document.querySelector('#line-items-table tbody');
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
  if (tbody && totalForms) {
    const count = tbody.querySelectorAll('tr.line-row').length; // incluye ocultas
    totalForms.value = String(count);
  }
}
/**-------------------------------------------------------------------------------------------------------------------------
   * Inserta una nueva fila de línea clonando el <template id="empty-form-template">,
   * reindexa el formset y recalcula los totales.
   * @function addRow
   * @returns {void}
    -------------------------------------------------------------------------------------------------------------------------*/
function addRow() {
    const tbody = document.querySelector('#line-items-table tbody');
  const tmpl = document.querySelector('#empty-form-template');
  if (!tmpl || !tbody) return;

  // índice siguiente = cuántas filas reales hay ahora
  const idx = tbody.querySelectorAll('tr.line-row').length;

  // ⚠️ Sustituimos __prefix__ por el índice ANTES de insertar
  const temp = document.createElement('tbody');
  temp.innerHTML = tmpl.innerHTML.replace(/__prefix__/g, String(idx)).trim();

  const newRow = temp.firstElementChild;
  tbody.appendChild(newRow);

  // Mantén tu pipeline habitual
  reindexAllRows();
  updateTotals();
}
/**-------------------------------------------------------------------------------------------------------------------------
   * Elimina (o marca para eliminar) la fila asociada al botón pulsado.
   * - Si existe el checkbox "-DELETE", lo marca y oculta la fila (patrón Django).
   * - Si no existe, remueve la fila del DOM y reindexa.
   * Siempre recalcula totales al finalizar.
   * @function removeRow
   * @param {HTMLElement} btn - Botón (o elemento hijo) dentro de la fila a eliminar.
   * @returns {void}
    -----------------------------------------------------------------------------------------------------------------------*/
function removeRow(btn) {
  const tr = btn.closest('tr.line-row');
  if (!tr) return;

  const idInput  = tr.querySelector('input[type="hidden"][name$="-id"]');
  const delInput = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
  const isInitial = !!(idInput && idInput.value);

  if (isInitial) {
    // Fila guardada en BD → marcar DELETE y ocultar (no reindexar)
    if (delInput) delInput.checked = true;
    tr.style.display = 'none';
    tr.classList.add('hidden');
    // NO tocamos índices ni TOTAL_FORMS
  } else {
    // Fila nueva → remover del DOM y reindexar todo
    tr.remove();
    reindexAllRows();
  }
  updateTotals();
}
/**-------------------------------------------------------------------------------------------------------------------------
   * Listener del botón "Agregar fila".
   * Usa encadenamiento opcional (?.) por si el botón no existe en la plantilla actual.
    ------------------------------------------------------------------------------------------------------------------------*/
document.getElementById('btn-add-row')?.addEventListener('click', addRow);
/**------------------------------------------------------------------------------------------------------------------------
   * Delegación de eventos para eliminar filas:
   * - Se escucha un único 'click' en el <tbody> y se detecta si el objetivo
   *   pertenece a un elemento con clase ".remove-row".
   * - Esto funciona incluso para filas agregadas dinámicamente.
    -----------------------------------------------------------------------------------------------------------------------*/
const tbody = document.querySelector('#line-items-table tbody');
if (tbody) {
    tbody.addEventListener('click', function(e) {
    if (e.target.closest('.remove-row')) {
        removeRow(e.target.closest('.remove-row'));
    }
    });
}
/**--------------------------------------------------------------------------------------------------------------------------
   *  renombra name/id/for para que los índices queden 0..n-1 contiguos
    --------------------------------------------------------------------------------------------------------------------------*/
function reindexAllRows() {
  const tbody = document.querySelector('#line-items-table tbody');
  const rows = [...tbody.querySelectorAll('tr.line-row')]; // incluye ocultas (las iniciales marcadas DELETE deben seguir contando)
  rows.forEach((tr, idx) => {
    tr.querySelectorAll('input, select, textarea, label').forEach(el => {
      ['name','id','for'].forEach(attr => {
        const val = el.getAttribute && el.getAttribute(attr);
        if (!val) return;
        // reemplaza -<num>- por -idx-
        el.setAttribute(attr, val.replace(/-(\d+)-/, `-${idx}-`));
      });
    });
  });
  // TOTAL_FORMS = número de filas (incluye las ocultas marcadas DELETE)
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');
  if (totalForms) totalForms.value = String(rows.length);
}


/**--------------------------------------------------------------------------------------------------------------------------
   * Recalcula totales en vivo con cada edición de cantidad/precio/descuento,
   * detectando los campos por su nombre con expresión regular.
   * @event input
    --------------------------------------------------------------------------------------------------------------------------*/
document.addEventListener('input', function(e) {
    const name = (e.target && e.target.name) ? e.target.name : '';
    const cambiaLinea = /-(cantidad|qty|quantity|precio|price|unit|descuento|discount)/i.test(name);
    const cambiaIva   = /impuesto_total/i.test(name); // <-- clave para IVA como %
    if (cambiaLinea || cambiaIva) {
    updateTotals();
}
});


// AUTORELLENO DE PRECIO UNITARIO AL ELEGIR PRODUCTO (usa data-endpoint-precio)
document.addEventListener('change', function(e) {
  const tr = e.target.closest('tr.line-row');
  if (!tr) return;

  console.log('[precio-auto] change en:', e.target.name || e.target.id); // ← AÑADE ESTO

  let prodSel = e.target.tagName === 'SELECT' ? e.target : null;
  if (!prodSel) return; // si el target no es SELECT, no hacemos nada

  const priceInput = tr.querySelector('input[name*="-precio"], input[name*="-price"], input[name*="-unit"]');
  if (!priceInput) return;

  const prodId = prodSel.value;
  if (!prodId) { priceInput.value = ''; updateTotals(); return; }

  const table = document.getElementById('line-items-table');
  const endpointTpl = table?.dataset?.endpointPrecio;
  if (!endpointTpl) return;

  const url = endpointTpl.replace(/\/0(\/|$)/, `/${prodId}$1`);
  console.log('[precio-auto] GET →', url); // ← AÑADE ESTO

  fetch(url, { method: 'GET' })
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(data => {
      const precio = Number(data.precio_unitario || 0);
      
    if (priceInput.type === 'number') {
    priceInput.value = precio.toFixed(2);        // usa punto
    if (!priceInput.step) priceInput.step = '0.01'; // por si el step era 1
}   else {
      priceInput.value = precio.toFixed(2).replace('.', ','); // si fuera text
}




      updateTotals();
    })
    .catch(() => {});
});

updateTotals();
})();// <- fin IIFE
</script>