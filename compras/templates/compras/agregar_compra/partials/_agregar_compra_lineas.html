{{ formset.management_form }}

{% if formset.non_form_errors %}
<div class="alert alert-danger">{{ formset.non_form_errors }}</div>
{% endif %}

<div class="table-responsive">
<!--
QuÃ© hace: aÃ±ade data-endpoint-precio en la <table id="line-items-table"> con el valor de {% url 'inventario:producto_precio' pk=0 %}.
Para quÃ©: asÃ­ el JS puede construir la URL final sustituyendo el 0 por el id del producto seleccionado.
Ventaja: cero dependencias de window.location.origin, cero problemas con subrutas, HTTPS, proxies o namespaces; Django siempre te da la ruta buena.    
-->
<table 
    class="table table-striped align-middle" 
    id="line-items-table"
    data-endpoint-precio="{% url 'inventario:producto_precio' pk=0 %}">
    <thead>
    <tr>
        {% if formset.forms %}
            {% for bf in formset.forms.0.visible_fields %}
                {% if bf.name != 'DELETE' %}
                    <th>{{ bf.label }}</th>
                {% endif %}
            {% endfor %}
        {% else %}
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Descuento</th>
            <th>Subtotal</th>
        {% endif %}
        <th class="text-end">Acciones</th>
    </tr>
    </thead>

    <tbody>
    {% for f in formset.forms %}
        <tr class="line-row">
            {% for bf in f.visible_fields %}
                {% if bf.name != 'DELETE' %}
                    <td>
                        {{ bf }}
                        {% for error in bf.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </td>
                {% endif %}
            {% endfor %}

            {# ðŸ‘‡ Si el formset tiene campo DELETE, lo renderizamos oculto para que el JS pueda marcarlo #}
            {% if f.fields.DELETE %}
                <td style="display:none">{{ f.DELETE }}</td>
            {% endif %}




            <td class="text-end">
                <button type="button" class="btn btn-link text-danger remove-row">Quitar</button>
            </td>


            {# Hidden fields normales (id, compra, etc.) #}
            {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>

{# Fila vacÃ­a para clonar #}
<template id="empty-form-template">
<tr class="line-row">
    {% with ef=formset.empty_form %}
        {% for bf in ef.visible_fields %}
            {% if bf.name != 'DELETE' %}
                <td>{{ bf.as_widget|safe }}</td>
            {% endif %}
        {% endfor %}

        {% if ef.fields.DELETE %}
            <td style="display:none">{{ ef.DELETE }}</td>
        {% endif %}


        <td class="text-end">
            <button type="button" class="btn btn-link text-danger remove-row">Quitar</button>
        </td>



        {% for hidden in ef.hidden_fields %}{{ hidden }}{% endfor %}
    {% endwith %}
</tr>
</template>