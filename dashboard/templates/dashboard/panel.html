{# templates/dashboard/panel.html #}
{% extends "base.html" %}
{% block title %}Dashboard · Tecknosfera{% endblock %}

{% block content %}
<div class="container py-3 text-start">
  <h2 class="mb-3">DASHBOARD</h2>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Compras (hoy)</div>
          <div class="h4 mb-0">${{ compras_hoy|floatformat:2 }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Ventas (hoy)</div>
          <div class="h4 mb-0">${{ ventas_hoy|floatformat:2 }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Compras (mes)</div>
          <div class="h4 mb-0">${{ compras_mes|floatformat:2 }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Ventas (mes)</div>
          <div class="h4 mb-0">${{ ventas_mes|floatformat:2 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs 2 -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card h-100 text-center shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Productos</div>
          <div class="h4 mb-0">{{ productos_activos }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 text-center shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted">Proveedores</div>
          <div class="h4 mb-0">{{ proveedores_activos }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 text-center shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted"># Compras</div>
          <div class="h4 mb-0">{{ compras_count }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card h-100 text-center shadow-sm">
        <div class="card-body">
          <div class="fw-bold text-muted"># Ventas</div>
          <div class="h4 mb-0">{{ ventas_count }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-7">
      <div class="card h-100 shadow-sm">
        <div class="card-body" style="height: 340px;">
          <div class="fw-bold mb-2">Compras vs Ventas · últimos 14 días</div>
          <canvas id="chartLine" style="width:100%; height: 280px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="card h-100 shadow-sm">
        <div class="card-body" style="height: 340px;">
          <div class="fw-bold mb-2">Top 5 productos vendidos</div>
          <canvas id="chartBar" style="width:100%; height: 280px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLAS FILA 1 -->
  <div class="row g-3">
    <!-- Top vendidos -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-2">Top vendidos (cantidad)</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Producto</th><th class="text-end">Cantidad</th></tr>
              </thead>
              <tbody>
                {% for it in top_vendidos %}
                  <tr>
                    <td>{{ it.nombre }}</td>
                    <td class="text-end">{{ it.cantidad }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Proveedores que más nos venden -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-2">Proveedores que más nos venden (Compras €)</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Proveedor</th><th class="text-end">Compras (€)</th></tr>
              </thead>
              <tbody>
                {% for it in top_proveedores_compras %}
                  <tr>
                    <td>{{ it.nombre }}</td>
                    <td class="text-end">{{ it.total|floatformat:2 }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLAS FILA 2 -->
  <div class="row g-3 mt-0">
    <!-- Proveedores con mayor descuento -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-2">Proveedores con mayor descuento (%)</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Proveedor</th><th class="text-end">Desc. medio (%)</th></tr>
              </thead>
              <tbody>
                {% for it in top_proveedores_descuento %}
                  <tr>
                    <td>{{ it.nombre }}</td>
                    <td class="text-end">{{ it.descuento_pct|floatformat:2 }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="2" class="text-center text-muted">Sin datos</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Stock bajo -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="fw-bold mb-2">Stock bajo (≤ mínimo)</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Producto</th><th class="text-end">Stock</th><th class="text-end">Mínimo</th></tr>
              </thead>
              <tbody>
                {% for p in low_stock %}
                  <tr>
                    <td>{{ p.nombre }}</td>
                    <td class="text-end">{{ p.stock }}</td>
                    <td class="text-end">{{ p.stock_minimo }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" class="text-center text-muted">Todo OK ✅</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  {{ chart|json_script:"chart-data" }}

  <script>
    const chart = JSON.parse(document.getElementById("chart-data").textContent);

    const labels      = chart.labels || [];
    const dataCompras = chart.compras || [];
    const dataVentas  = chart.ventas || [];
    const topLabels   = chart.top_labels || [];
    const topData     = chart.top_data || [];

    // Línea: Compras vs Ventas
    const ctxLine = document.getElementById('chartLine').getContext('2d');
    new Chart(ctxLine, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Compras', data: dataCompras, tension: 0.3, borderWidth: 2 },
          { label: 'Ventas',  data: dataVentas,  tension: 0.3, borderWidth: 2 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // Barras: Top vendidos
    const ctxBar = document.getElementById('chartBar').getContext('2d');
    const palette = ['#3da9fc', '#ef4565', '#94a1b2', '#0ea5e9', '#f59e0b'];
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: topLabels,
        datasets: [{
          label: 'Unidades',
          data: topData,
          backgroundColor: palette.map(c => c + '33'),
          borderColor: palette,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  </script>
{% endblock %}