{{ formset.management_form }}

{% if formset.non_form_errors %}
  <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
{% endif %}

<div class="table-responsive">
  <!--
    Igual que en compras: el JS tomará este data-endpoint-precio y reemplazará el "0"
    por el id del producto seleccionado para consultar su precio.
  -->
  <table
    class="table table-striped align-middle"
    id="line-items-table"
    data-endpoint-precio="{% url 'inventario:producto_precio' pk=0 %}">
    <thead>
      <tr>
        {% if formset.forms %}
          {% for bf in formset.forms.0.visible_fields %}
            {% if bf.name != 'DELETE' %}
              <th>{{ bf.label }}</th>
            {% endif %}
          {% endfor %}
        {% else %}
          {# Cabeceras por defecto (en caso extremo sin forms) #}
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio unitario</th>
          <th>Descuento (%)</th>
          <th>Subtotal</th>
        {% endif %}
        <th class="text-end">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for f in formset.forms %}
        <tr class="line-row">
          {# Campos visibles de la línea (producto, cantidad, precio_unitario, descuento, subtotal si corresponde) #}
          {% for bf in f.visible_fields %}
            {% if bf.name != 'DELETE' %}
              <td>
                {{ bf }}
                {% for error in bf.errors %}
                  <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
              </td>
            {% endif %}
          {% endfor %}

          {# Campo DELETE oculto (si el formset lo trae) para permitir quitar filas vía JS #}
          {% if f.fields.DELETE %}
            <td style="display:none">{{ f.DELETE }}</td>
          {% endif %}

          <td class="text-end">
            <button type="button" class="btn btn-link text-danger remove-row">Quitar</button>
          </td>

          {# Hidden fields normales (id, venta, etc.) #}
          {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# Fila vacía para clonado dinámico #}
<template id="empty-form-template">
  <tr class="line-row">
    {% with ef=formset.empty_form %}
      {% for bf in ef.visible_fields %}
        {% if bf.name != 'DELETE' %}
          <td>{{ bf.as_widget|safe }}</td>
        {% endif %}
      {% endfor %}

      {% if ef.fields.DELETE %}
        <td style="display:none">{{ ef.DELETE }}</td>
      {% endif %}

      <td class="text-end">
        <button type="button" class="btn btn-link text-danger remove-row">Quitar</button>
      </td>

      {% for hidden in ef.hidden_fields %}{{ hidden }}{% endfor %}
    {% endwith %}
  </tr>
</template>