<script>
/**
 * Scripts de VENTAS — agregar (alineado con tus nombres reales)
 * - Campos por línea: producto, cantidad, precio_unitario, descuento (%)
 * - Descuento global: form.descuento_total (valor absoluto en €)
 * - Impuesto (IVA): form.impuesto (porcentaje %)
 * - Totales UI: #subtotal-general, #descuento-general, #impuestos-general, #total-general
 * - Add/Remove + reindex formset
 * - Autorelleno de precio por producto vía data-endpoint-precio (URL con pk=0)
 */
(function () {
  // Helpers básicos
  const qs  = (s, c=document) => c.querySelector(s);
  const qsa = (s, c=document) => Array.from(c.querySelectorAll(s));

  // "12.345,67" -> 12345.67 ; "12.90" -> 12.9
  function toNumber(val) {
    if (val == null) return 0;
    if (typeof val === 'number') return isFinite(val) ? val : 0;
    const s = String(val).trim();
    if (!s) return 0;
    if (s.includes(',')) return Number(s.replace(/\./g, '').replace(',', '.')) || 0;
    return Number(s) || 0;
  }
  const fmt = (n) => (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);

  // Elementos base
  const table  = qs('#line-items-table');
  const btnAdd = qs('#btn-add-row');
  const tpl    = qs('#empty-form-template');
  if (!table || !btnAdd || !tpl) {
    console.warn('[ventas] Faltan elementos base (#line-items-table, #btn-add-row, #empty-form-template).');
    return;
  }

  const form = table.closest('form') || document;

  // Management form (detecta prefijo del formset)
  const mgmtTotal   = qs('input[name$="-TOTAL_FORMS"]', form);
  const mgmtInitial = qs('input[name$="-INITIAL_FORMS"]', form);
  if (!mgmtTotal || !mgmtInitial) {
    console.warn('[ventas] No se encontró el management form del formset.');
  }
  const PREFIX = mgmtTotal ? mgmtTotal.name.replace(/-TOTAL_FORMS$/, '') : 'lineas';

  // Inputs de cabecera relevantes
  const inDescGlobal = qs('input[name="descuento_total"]', form); // € absoluto
  const inImpuesto   = qs('input[name="impuesto"]', form);        // % (23 -> 23%)
  const inGanancia   = qs('input[name="ganancia_pct"]', form);    // % (ej. 50 -> 50%)

  // IDs de totales UI (panel lateral)
  const ui = {
    subtotal:  qs('#subtotal-general'),
    descuento: qs('#descuento-general'),
    ganancia:  qs('#ganancia-general'),
    impuestos: qs('#impuestos-general'),
    total:     qs('#total-general'),
  };

  // Endpoint para precios por producto (colocado en la <table data-endpoint-precio=".../0/...">)
  const endpointTpl = table.dataset.endpointPrecio || null;

  // --- Cálculos ---
  function calcLinea(row) {
    const inCant = qs(`input[name^="${PREFIX}"][name$="-cantidad"]`, row);
    const inPU   = qs(`input[name^="${PREFIX}"][name$="-precio_unitario"]`, row);
    const inDesc = qs(`input[name^="${PREFIX}"][name$="-descuento"]`, row); // % por línea

    const cantidad = Math.max(0, toNumber(inCant?.value));
    const pu       = Math.max(0, toNumber(inPU?.value));
    const descPct  = Math.max(0, Math.min(100, toNumber(inDesc?.value)));

    let line = cantidad * pu;
    if (descPct) line = line * (1 - descPct / 100);
    return line;
  }

  function updateTotals() {
    const rows = qsa('.line-row', table.tBodies[0] || table);
    const subtotal = rows.reduce((acc, r) => acc + calcLinea(r), 0);

    // Descuento global (absoluto, en €)
    const descGlobal = Math.max(0, toNumber(inDescGlobal?.value));

    // Base imponible
    const base = Math.max(0, subtotal - descGlobal);

    // Impuesto como porcentaje (%)
    const ivaPct = Math.max(0, toNumber(inImpuesto?.value));
    const impuestos = base * (ivaPct / 100);

    // Ganancia en €: se calcula SOBRE EL SUBTOTAL (antes de impuestos), SIN IVA
  const gananciaPct = Math.max(0, toNumber(inGanancia?.value));
  const ganancia = subtotal * (gananciaPct / 100);

    const total = base + impuestos;

    if (ui.subtotal)  ui.subtotal.textContent  = fmt(subtotal).replace('.', ',');
    if (ui.descuento) ui.descuento.textContent = fmt(descGlobal).replace('.', ',');
    if (ui.ganancia)  ui.ganancia.textContent  = fmt(ganancia).replace('.', ',');
    if (ui.impuestos) ui.impuestos.textContent = fmt(impuestos).replace('.', ',');
    if (ui.total)     ui.total.textContent     = fmt(total).replace('.', ',');
  }

  // --- Reindex ---
  function reindexAllRows() {
    const tbody = table.tBodies[0] || table;
    const rows = qsa('tr.line-row', tbody); // incluye ocultas (marcadas DELETE)
    rows.forEach((tr, idx) => {
      qsa('input, select, textarea, label', tr).forEach(el => {
        ['name','id','for'].forEach(attr => {
          const v = el.getAttribute && el.getAttribute(attr);
          if (!v) return;
          el.setAttribute(attr, v.replace(/-(\d+)-/, `-${idx}-`));
        });
      });
    });
    if (mgmtTotal) mgmtTotal.value = String(rows.length);
  }

  // --- Add / Remove ---
  function addRow() {
    const tbody = table.tBodies[0] || table;
    const idx = qsa('tr.line-row', tbody).length;

    const temp = document.createElement('tbody');
    temp.innerHTML = tpl.innerHTML.replace(/__prefix__/g, String(idx)).trim();

    const newRow = temp.firstElementChild;
    if (!newRow) return;

    tbody.appendChild(newRow);
    attachRowListeners(newRow);
    reindexAllRows();
    updateTotals();
  }

  function removeRow(btn) {
    const tr = btn.closest('tr.line-row');
    if (!tr) return;

    const idInput  = qs('input[type="hidden"][name$="-id"]', tr);
    const delInput = qs('input[type="checkbox"][name$="-DELETE"]', tr);
    const isInitial = !!(idInput && idInput.value);

    if (isInitial) {
      if (delInput) delInput.checked = true;
      tr.style.display = 'none';
      tr.classList.add('hidden');
      // No reindexamos para no romper índices de iniciales
    } else {
      tr.remove();
      reindexAllRows();
    }
    updateTotals();
  }

  // --- Precio automático al elegir producto ---
  function attachPriceAutofill(scope) {
    scope.addEventListener('change', (e) => {
      const sel = e.target;
      if (sel.tagName !== 'SELECT') return;
      if (!endpointTpl) return;

      const row = sel.closest('tr.line-row');
      if (!row) return;

      const priceInput = qs(`input[name^="${PREFIX}"][name$="-precio_unitario"]`, row);
      if (!priceInput) return;

      const prodId = sel.value;
      if (!prodId) { priceInput.value = ''; updateTotals(); return; }

      // Reemplaza la /0/ del template por el id real
      const url = endpointTpl.replace(/\/0(\/|$)/, `/${prodId}$1`);
      fetch(url, { method: 'GET' })
        .then(r => r.ok ? r.json() : Promise.reject(r))
        .then(data => {
          const precio = Number(data.precio_unitario || 0);
          // Si es type=number usamos punto decimal y step 0.01
          if (priceInput.type === 'number') {
            if (!priceInput.step) priceInput.step = '0.01';
            priceInput.value = fmt(precio);
          } else {
            priceInput.value = fmt(precio).replace('.', ',');
          }
          updateTotals();
        })
        .catch(() => {/* silencioso */});
    });
  }

  // --- Listeners por fila y globales ---
  function attachRowListeners(scope=document) {
    // Recalcular cuando cambian cantidad / precio_unitario / descuento
    qsa(`input[name^="${PREFIX}"][name$="-cantidad"], input[name^="${PREFIX}"][name$="-precio_unitario"], input[name^="${PREFIX}"][name$="-descuento"]`, scope)
      .forEach(inp => inp.addEventListener('input', updateTotals));

    // Quitar fila
    qsa('.remove-row', scope).forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        removeRow(btn);
      });
    });
  }
  
  // Botón agregar
  btnAdd.addEventListener('click', (ev) => { ev.preventDefault(); addRow(); });

  // Delegaciones globales
  attachRowListeners();          // para filas ya renderizadas
  attachPriceAutofill(table);    // precios por producto
  // Cabecera: cambios en descuento_total (€) o impuesto (%)
  inDescGlobal && inDescGlobal.addEventListener('input', updateTotals);
  inImpuesto   && inImpuesto.addEventListener('input', updateTotals);
  inGanancia && inGanancia.addEventListener('input', updateTotals);

  // Init
  // Asegurar TOTAL_FORMS correcto al cargar:
  (function ensureTotalForms() {
    const tbody = table.tBodies[0] || table;
    const count = qsa('tr.line-row', tbody).length;
    if (mgmtTotal) mgmtTotal.value = String(count);
  })();
  updateTotals();
})();
</script>