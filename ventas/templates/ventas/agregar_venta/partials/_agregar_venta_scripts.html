<script>
/**
 * Scripts de VENTAS — Agregar
 * ------------------------------------------------------------
 * Supuesto de negocio (alineado a tu expectativa):
 *   El campo de cabecera `descuento_total` se INGRESA como PORCENTAJE (0–100),
 *   pero el backend espera un MONTO en dinero. Este script:
 *     1) Usa `descuento_total` como % para calcular el descuento en dinero.
 *     2) Muestra el descuento en dinero en el panel de totales.
 *     3) Justo antes de enviar el formulario, SOBREESCRIBE el valor del input
 *        `descuento_total` con el dinero calculado, para que el backend reste
 *        el monto correcto (sin cambiar tus vistas/servicios).
 *
 * Fórmulas:
 *   - total_línea = cantidad * precio_unitario * (1 - descuento_linea%/100)
 *   - subtotal    = Σ total_línea
 *   - desc_money  = subtotal * (descuento_total% / 100)    <-- cabecera (este script)
 *   - base        = subtotal - desc_money
 *   - impuestos   = base * (impuesto% / 100)
 *   - total       = base + impuestos
 *   - ganancia    = subtotal * (ganancia% / 100)  (solo informativa)
 *
 * Requisitos en DOM (nombres reales que ya usas):
 *   - Tabla de líneas:      #line-items-table (con <tbody> y filas .line-row)
 *   - Template de fila:     #empty-form-template (con __prefix__)
 *   - Botón agregar:        #btn-add-row
 *   - Management formset:   inputs name$="-TOTAL_FORMS" y name$="-INITIAL_FORMS"
 *   - Inputs por línea:
 *       name="lineas-*-producto" (select, para autofill de precio)
 *       name="lineas-*-cantidad" (number)
 *       name="lineas-*-precio_unitario" (number)
 *       name="lineas-*-descuento" (number, %, opcional)
 *   - Inputs cabecera:
 *       name="descuento_total"  <-- % (este script lo toma como porcentaje)
 *       name="impuesto"         <-- % IVA
 *       name="ganancia_pct"     <-- % (info)
 *   - Totales UI:
 *       #subtotal-general, #descuento-general, #ganancia-general,
 *       #impuestos-general, #total-general
 *   - Autofill de precio por producto:
 *       La tabla debe traer data-endpoint-precio=".../0/..." (0 se reemplaza por el id real)
 */

(function () {
  // ---------------- Utilidades ----------------
  const qs  = (s, c=document) => c.querySelector(s);
  const qsa = (s, c=document) => Array.from(c.querySelectorAll(s));

  /**
   * Convierte cadenas locales a número (acepta "12.345,67" o "12.67").
   * @param {any} val
   * @returns {number}
   */
  function toNumber(val) {
    if (val == null) return 0;
    if (typeof val === 'number') return isFinite(val) ? val : 0;
    const s = String(val).trim();
    if (!s) return 0;
    if (s.includes(',')) return Number(s.replace(/\./g, '').replace(',', '.')) || 0;
    return Number(s) || 0;
  }

  /**
   * Redondea a 2 decimales tipo dinero (mitigando errores binarios).
   * @param {number} n
   * @returns {string} "0.00"
   */
  const fmt = (n) => (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);

  // ---------------- Elementos base ----------------
  const table  = qs('#line-items-table');
  const btnAdd = qs('#btn-add-row');
  const tpl    = qs('#empty-form-template');
  if (!table || !btnAdd || !tpl) {
    console.warn('[ventas] Faltan elementos base (#line-items-table, #btn-add-row, #empty-form-template).');
    return;
  }

  const form = table.closest('form') || document;

  // Management form (prefijo del formset)
  const mgmtTotal   = qs('input[name$="-TOTAL_FORMS"]', form);
  const mgmtInitial = qs('input[name$="-INITIAL_FORMS"]', form);
  if (!mgmtTotal || !mgmtInitial) {
    console.warn('[ventas] No se encontró el management form del formset.');
  }
  const PREFIX = mgmtTotal ? mgmtTotal.name.replace(/-TOTAL_FORMS$/, '') : 'lineas';

  // ---------------- Inputs de cabecera ----------------
  const inDescPct  = qs('input[name="descuento_total"]', form); // ← SE INGRESA COMO %
  const inImpuesto = qs('input[name="impuesto"]', form);        // % IVA
  const inGanancia = qs('input[name="ganancia_pct"]', form);    // % (informativa)

  // ---------------- Totales UI ----------------
  const ui = {
    subtotal:  qs('#subtotal-general'),
    descuento: qs('#descuento-general'),
    ganancia:  qs('#ganancia-general'),
    impuestos: qs('#impuestos-general'),
    total:     qs('#total-general'),
  };

  // ---------------- Endpoint de precio por producto ----------------
  // Tabla debe venir con data-endpoint-precio=".../0/..." (el 0 se sustituye por el id real)
  const endpointTpl = table.dataset.endpointPrecio || null;

  // ---------------- Cálculos por línea ----------------
  /**
   * Calcula el total de una línea:
   *   total = cantidad * precio_unitario * (1 - descuento_linea%/100)
   * @param {HTMLTableRowElement} row
   * @returns {number}
   */
  function calcLinea(row) {
    const inCant = qs(`input[name^="${PREFIX}"][name$="-cantidad"]`, row);
    const inPU   = qs(`input[name^="${PREFIX}"][name$="-precio_unitario"]`, row);
    const inDesc = qs(`input[name^="${PREFIX}"][name$="-descuento"]`, row); // % por línea

    const cantidad = Math.max(0, toNumber(inCant?.value));
    const pu       = Math.max(0, toNumber(inPU?.value));
    const descPct  = Math.min(Math.max(0, toNumber(inDesc?.value)), 100);

    let line = cantidad * pu;
    if (descPct) line = line * (1 - descPct / 100);
    return line;
  }

  // ---------------- Cálculo de totales ----------------
  /**
   * Recalcula todos los totales de la venta y refresca la UI.
   * Interpreta `descuento_total` de cabecera como PORCENTAJE.
   * Además, guarda el valor de descuento en dinero en un atributo de dataset
   * para usarlo en el submit (evita sobrescribir el input mientras el usuario escribe).
   */
  function updateTotals() {
    // 1) Subtotal (suma de líneas ya con % de línea aplicado)
    const rows = qsa('.line-row', table.tBodies[0] || table);
    const subtotal = rows.reduce((acc, r) => acc + calcLinea(r), 0);

    // 2) Descuento global (cabecera) COMO PORCENTAJE
    const pct = Math.min(Math.max(0, toNumber(inDescPct?.value)), 100); // 0..100
    const descMoney = subtotal * (pct / 100);

    // Guardar el dinero calculado en dataset para el submit
    if (inDescPct) {
      inDescPct.dataset._moneyValue = String(descMoney); // p.ej. "49.5"
      inDescPct.dataset._isPercent  = 'true';
    }

    // 3) Base, impuestos y total
    const base = Math.max(0, subtotal - descMoney);

    const ivaPct    = Math.min(Math.max(0, toNumber(inImpuesto?.value)), 100);
    const impuestos = base * (ivaPct / 100);

    const gananciaPct = Math.min(Math.max(0, toNumber(inGanancia?.value)), 100);
    const ganancia    = subtotal * (gananciaPct / 100); // solo informativa

    const total = base + impuestos;

    // 4) Refrescar UI en formato local (coma decimal en visual)
    if (ui.subtotal)  ui.subtotal.textContent  = fmt(subtotal).replace('.', ',');
    if (ui.descuento) ui.descuento.textContent = fmt(descMoney).replace('.', ',');
    if (ui.ganancia)  ui.ganancia.textContent  = fmt(ganancia).replace('.', ',');
    if (ui.impuestos) ui.impuestos.textContent = fmt(impuestos).replace('.', ',');
    if (ui.total)     ui.total.textContent     = fmt(total).replace('.', ',');
  }

  // ---------------- Reindex / Add / Remove ----------------
  /**
   * Reindexa los atributos name/id/for de cada fila del formset tras cambios.
   */
  function reindexAllRows() {
    const tbody = table.tBodies[0] || table;
    const rows = qsa('tr.line-row', tbody); // incluye ocultas (DELETE marcadas)
    rows.forEach((tr, idx) => {
      qsa('input, select, textarea, label', tr).forEach(el => {
        ['name','id','for'].forEach(attr => {
          const v = el.getAttribute && el.getAttribute(attr);
          if (!v) return;
          el.setAttribute(attr, v.replace(/-(\d+)-/, `-${idx}-`));
        });
      });
    });
    if (mgmtTotal) mgmtTotal.value = String(rows.length);
  }

  /**
   * Inserta una nueva fila a partir del template y recalcula totales.
   */
  function addRow() {
    const tbody = table.tBodies[0] || table;
    const idx = qsa('tr.line-row', tbody).length;

    const temp = document.createElement('tbody');
    temp.innerHTML = tpl.innerHTML.replace(/__prefix__/g, String(idx)).trim();

    const newRow = temp.firstElementChild;
    if (!newRow) return;

    tbody.appendChild(newRow);
    attachRowListeners(newRow);
    reindexAllRows();
    updateTotals();
  }

  /**
   * Quita (o marca para borrar) una fila del formset y recalcula totales.
   * @param {HTMLElement} btn
   */
  function removeRow(btn) {
    const tr = btn.closest('tr.line-row');
    if (!tr) return;

    const idInput  = qs('input[type="hidden"][name$="-id"]', tr);
    const delInput = qs('input[type="checkbox"][name$="-DELETE"]', tr);
    const isInitial = !!(idInput && idInput.value);

    if (isInitial) {
      if (delInput) delInput.checked = true;
      tr.style.display = 'none';
      tr.classList.add('hidden');
      // No reindex para no romper índices de iniciales
    } else {
      tr.remove();
      reindexAllRows();
    }
    updateTotals();
  }

  // ---------------- Autofill de precio por producto ----------------
  /**
   * Escucha cambios en SELECT de producto dentro de la tabla y hace fetch
   * al endpoint (reemplazando /0/ por el id real) para autocompletar precio_unitario.
   * @param {HTMLElement} scope
   */
  function attachPriceAutofill(scope) {
    scope.addEventListener('change', (e) => {
      const sel = e.target;
      if (sel.tagName !== 'SELECT') return;
      if (!endpointTpl) return;

      const row = sel.closest('tr.line-row');
      if (!row) return;

      const priceInput = qs(`input[name^="${PREFIX}"][name$="-precio_unitario"]`, row);
      if (!priceInput) return;

      const prodId = sel.value;
      if (!prodId) { priceInput.value = ''; updateTotals(); return; }

      // Sustituir la /0/ del template por el id real
      const url = endpointTpl.replace(/\/0(\/|$)/, `/${prodId}$1`);
      fetch(url, { method: 'GET' })
        .then(r => r.ok ? r.json() : Promise.reject(r))
        .then(data => {
          const precio = Number(data.precio_unitario || 0);
          if (priceInput.type === 'number') {
            if (!priceInput.step) priceInput.step = '0.01';
            priceInput.value = fmt(precio); // con punto para number
          } else {
            priceInput.value = fmt(precio).replace('.', ',');
          }
          updateTotals();
        })
        .catch(() => {/* silencioso */});
    });
  }

  // ---------------- Listeners por fila y globales ----------------
  /**
   * Conecta listeners de inputs por fila para recalcular en vivo y remover filas.
   * @param {HTMLElement} scope
   */
  function attachRowListeners(scope=document) {
    // Recalcular al cambiar cantidad / precio_unitario / descuento de línea
    qsa(
      `input[name^="${PREFIX}"][name$="-cantidad"],` +
      `input[name^="${PREFIX}"][name$="-precio_unitario"],` +
      `input[name^="${PREFIX}"][name$="-descuento"]`,
      scope
    ).forEach(inp => inp.addEventListener('input', updateTotals));

    // Quitar fila
    qsa('.remove-row', scope).forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        removeRow(btn);
      });
    });
  }

  // Botón agregar
  btnAdd.addEventListener('click', (ev) => { ev.preventDefault(); addRow(); });

  // Delegaciones globales
  attachRowListeners();       // filas ya renderizadas
  attachPriceAutofill(table); // autofill de precio

  // Cabecera: cualquier cambio en % de descuento, IVA o ganancia recalcula totales
  inDescPct  && inDescPct.addEventListener('input', updateTotals);
  inImpuesto && inImpuesto.addEventListener('input', updateTotals);
  inGanancia && inGanancia.addEventListener('input', updateTotals);

  // ---------------- Submit: convertir % a dinero para el backend ----------------
  /**
   * Antes de enviar el formulario:
   *  - Si interpretamos `descuento_total` como %, sustituimos su valor por el monto (€)
   *    previamente calculado (guardado en dataset._moneyValue).
   *  - Así el backend recibe el dinero correcto sin cambios en server.
   */
  form.addEventListener('submit', () => {
    if (!inDescPct) return;
    if (inDescPct.dataset._isPercent === 'true') {
      // Usar punto decimal para POST
      const money = Number(inDescPct.dataset._moneyValue || 0);
      inDescPct.value = fmt(money);
    }
  });

  // ---------------- Init ----------------
  // Asegurar TOTAL_FORMS correcto al cargar
  (function ensureTotalForms() {
    const tbody = table.tBodies[0] || table;
    const count = qsa('tr.line-row', tbody).length;
    if (mgmtTotal) mgmtTotal.value = String(count);
  })();

  updateTotals();
})();
</script>