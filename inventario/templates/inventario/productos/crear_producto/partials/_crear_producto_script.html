<script>
(function(){
  // Utilidades
  function toNumber(v) {
    if (v == null) return 0;
    const s = String(v).trim().replace(/\./g, '').replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function updateResumenProducto() {
  const pc = document.querySelector('[name$="precio_compra"]'); // número
  const gn = document.querySelector('[name$="ganancia"]');      // porcentaje
  const st = document.querySelector('[name$="stock"]');
  const ac = document.querySelector('[name$="activo"]');

  const precioCompra = pc ? toNumber(pc.value) : 0;
  const gananciaPct  = gn ? toNumber(gn.value) : 0;

  // Cálculo en vivo (preview, no persiste):
  const precioVentaCalc = precioCompra * (1 + (gananciaPct / 100));
  const margenCalc      = precioVentaCalc - precioCompra;

  // Targets del resumen (ya existen en tu template)
  const elPV = document.getElementById('resumen-precio-venta');
  const elMG = document.getElementById('resumen-margen');
  const elST = document.getElementById('resumen-stock');
  const elES = document.getElementById('resumen-estado');

  if (elPV) elPV.textContent = precioVentaCalc.toFixed(2);
  if (elMG) elMG.textContent = margenCalc.toFixed(2);
  if (elST) elST.textContent = st ? (toNumber(st.value)).toString() : '0';
  if (elES) elES.textContent = (ac && ac.checked) ? 'Activo' : 'Inactivo';
}

  // ===== Formset (opcional) =====
  const table = document.getElementById('line-items-table');
  const btnAdd = document.getElementById('btn-add-row');

  function reindexFormset() {
    if (!table) return;
    const prefix = table.dataset.formsetPrefix || '';
    const rows = table.querySelectorAll('tbody tr.line-row');
    rows.forEach((tr, idx) => {
      tr.querySelectorAll('input, select, textarea, label').forEach(el => {
        ['name','id','for'].forEach(attr => {
          const val = el.getAttribute(attr);
          if (!val) return;
          el.setAttribute(attr, val.replace(new RegExp(prefix + '-\\d+-'), `${prefix}-${idx}-`));
        });
      });
    });
    const totalForms = document.querySelector(`input[name="${table.dataset.formsetPrefix}-TOTAL_FORMS"]`);
    if (totalForms) totalForms.value = rows.length;
  }

  function addRow() {
    if (!table) return;
    const tpl = document.getElementById('empty-form-template');
    if (!tpl) return;
    const clone = tpl.content.firstElementChild.cloneNode(true);
    table.querySelector('tbody').appendChild(clone);
    reindexFormset();
    updateResumenProducto();
  }

  function removeRow(ev) {
    const btn = ev.target.closest('.remove-row');
    if (!btn) return;
    const tr = btn.closest('tr.line-row');
    if (!tr) return;
    tr.remove();
    reindexFormset();
    updateResumenProducto();
  }
  
  // FUNCIONES INGRESADAS DESPUES DE LA MIGRACION ++++++++++++++++++++++++++++++++++++
  function computeStockMin(val){
    const n = Math.max(0, Number(String(val).replace(/\./g,'').replace(',','.')) || 0);
    return Math.floor(n * 0.90);
  }

  function maybeAutofillStockMinimo() {
    const stockInput = document.querySelector('[name$="stock"]');
    const minInput   = document.querySelector('[name$="stock_minimo"]');
    if (!stockInput || !minInput) return;

    const userEdited = minInput.dataset.userEdited === '1';
    if (!userEdited && (minInput.value === '' || minInput.dataset.auto === '1')) {
      minInput.value = String(computeStockMin(stockInput.value));
      minInput.dataset.auto = '1';
      }
  }
  
  
  // Listeners
  // Recalcular al escribir en campos clave
  document.addEventListener('input', (ev) => {
  const name = ev.target.name || '';



  // Actualiza el resumen cuando cambien estos campos
  if (
    name.endsWith('precio_compra') ||
    name.endsWith('ganancia') ||          // ← AÑADIDO
    name.endsWith('precio_venta') ||      // (puede quedar, no estorba)
    name.endsWith('stock')
  ) {
    updateResumenProducto();
  }
  // Recalcula 90% al cambiar stock (solo si sigue en modo auto)
  if (name.endsWith('stock')) {
    maybeAutofillStockMinimo();
  }
  // Si el usuario edita manualmente el stock_minimo, desactiva el modo auto
  if (name.endsWith('stock_minimo')) {
    ev.target.dataset.userEdited = '1';
    ev.target.dataset.auto = '0';
  }
});

  updateResumenProducto();

(function initAutofill() {
  const minInput = document.querySelector('[name$="stock_minimo"]');
  if (minInput && (minInput.value === '' || minInput.value == null)) {
    minInput.dataset.userEdited = '0';
    minInput.dataset.auto = '1';
    maybeAutofillStockMinimo();
  }
 })(); // <-- cierre de la IIFE

// Exponer para debug (temporal)
window.__producto_updateResumen = updateResumenProducto;

})(); // <-- cierre de la IIFE principal
</script>